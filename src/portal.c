#include "misc.h"
#include "video.h"
#include "game.h"

typedef struct
{
    int     x, y;
    BYTE    paper, ink;
} PORTAL;

WORD    portalGfx[20][16] =
{
    {65535, 37449, 46811, 65535, 37449, 46811, 65535, 37449, 46811, 65535, 37449, 46811, 65535, 37449, 46811, 65535},
    {65535, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 65535},
    {65535, 33861, 39321, 41505, 41505, 39321, 33861, 33861, 39321, 41505, 41505, 39321, 33861, 33861, 39321, 65535},
    {8738, 4369, 34952, 17476, 8738, 4369, 34952, 17476, 8738, 4369, 34952, 17476, 8738, 4369, 34952, 17476},
    {65535, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 37449, 65535},
    {65535, 33153, 49149, 49149, 45069, 45069, 45069, 61455, 61455, 45069, 45069, 45069, 49149, 49149, 33153, 65535},
    {65535, 33153, 33153, 33153, 33153, 33153, 33153, 65535, 65535, 33153, 33153, 33153, 33153, 33153, 33153, 65535},
    {65535, 32769, 49155, 40965, 36873, 51219, 42021, 37449, 51603, 42021, 37449, 51603, 42021, 51603, 37449, 65535},
    {65535, 32769, 33153, 33345, 33825, 34833, 36873, 41349, 41349, 36873, 34833, 33825, 33345, 33153, 32769, 65535},
    {65535, 63631, 34961, 43665, 43669, 35461, 37009, 54713, 54613, 53573, 35129, 35075, 43179, 43691, 35465, 65535},
    {65535, 55979, 60011, 65535, 36873, 36873, 65535, 36873, 36873, 65535, 36873, 36873, 65535, 36873, 36873, 65535},
    {65535, 32769, 36849, 36849, 36849, 36849, 36849, 35889, 35889, 36849, 36849, 36849, 36849, 36849, 32769, 65535},
    {960, 2016, 4080, 2448, 2448, 2016, 1440, 576, 24966, 63519, 65151, 1504, 1952, 65151, 63519, 24582},
    {65535, 65535, 64575, 63519, 61455, 57351, 49539, 49731, 49731, 49539, 57351, 61455, 63519, 64575, 65535, 65535},
    {65535, 32769, 32769, 32769, 32769, 34817, 43521, 39997, 65351, 39937, 43521, 34817, 32769, 32769, 32769, 65535},
    {65535, 33153, 33153, 65535, 33153, 33153, 65535, 33153, 33153, 65535, 33153, 33153, 65535, 33153, 33153, 65535},
    {65535, 32769, 49149, 40965, 42405, 42405, 42405, 42405, 42405, 42405, 45045, 42405, 42405, 42405, 42405, 65535},
    {65535, 32769, 45069, 40965, 43605, 43605, 43605, 43605, 43605, 43605, 43605, 43605, 40965, 45069, 32769, 65535},
    {65535, 32769, 49149, 40965, 45045, 43029, 43989, 43605, 43605, 43989, 43029, 45045, 40965, 49149, 32769, 65535},
    {65535, 63519, 57351, 49155, 50115, 34785, 34785, 34785, 50115, 49539, 57735, 45453, 33153, 33153, 33153, 65535}
};

PORTAL  portalInfo[20] =
{
    {29, 13, 0x7, 0x5}, {29, 13, 0x4, 0xf}, {29, 11, 0xa, 0xe}, {29, 1, 0xa, 0x5}, {15, 13, 0x1, 0x0},
    {29, 0, 0x1, 0xa}, {15, 13, 0xe, 0xf}, {15, 13, 0x1, 0x6}, {1, 0, 0xc, 0xf}, {12, 13, 0x1, 0x5},
    {1, 1, 0xe, 0xc}, {15, 13, 0x8, 0xa}, {1, 13, 0x1, 0x7}, {15, 0, 0x9, 0x6}, {1, 3, 0x6, 0x5},
    {12, 5, 0xc, 0x2}, {29, 1, 0x6, 0x2}, {29, 0, 0x8, 0xd}, {1, 1, 0x5, 0x6}, {19, 5, 0xf, 0xc}
};

int     portalTile, portalPos;
BYTE    portalPaper[2], portalInk[2];
WORD    *portalSprite;
int     portalFlash;

void DoPortalTicker()
{
    portalFlash = videoFlash;

    if (portalTile != minerTile)
    {
        return;
    }

    if (gameLevel == TWENTY && cheatEnabled == 0)
    {
        Action = Victory_Action;
    }
    else
    {
        Action = Trans_Action;
    }
}

void Portal_Drawer()
{
    Video_Sprite(portalPos, portalSprite, portalPaper[portalFlash], portalInk[portalFlash]);
}

void Portal_Init()
{
    PORTAL  *portal = &portalInfo[gameLevel];

    portalPaper[0] = portalInk[1] = portal->paper;
    portalInk[0] = portalPaper[1] = portal->ink;

    portalFlash = 0;

    portalTile = portal->y * 32 + portal->x;
    portalPos = portal->y * 8 * WIDTH + portal->x * 8;
    portalSprite = portalGfx[gameLevel];
}
